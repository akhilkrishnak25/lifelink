<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Register for LifeLink - Create an account to donate or receive blood">
    <title>Register - LifeLink</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <script src="js/session.js"></script>
    <script>
        // If already logged in, go directly to home
        Session.redirectIfLoggedIn();
    </script>
    
    <!-- Skip to main content -->
    <a href="#registerForm" class="skip-link" style="position: absolute; top: -40px; left: 0; background: #dc3545; color: white; padding: 8px 16px; z-index: 9999; transition: top 0.3s;" onfocus="this.style.top='0'" onblur="this.style.top='-40px'">Skip to registration form</a>
    
    <header class="header" role="banner">
        <div class="container">
            <h1>ü©∏ LifeLink</h1>
            <p>Create New Account</p>
        </div>
    </header>

    <main class="container" style="margin-top: 2rem; max-width: 600px;" role="main">
        <!-- Alert Messages -->
        <div id="alertContainer" role="alert" aria-live="polite"></div>

        <!-- Registration Form -->
        <div class="card">
            <div class="card-header">Register</div>
            <form id="registerForm" aria-label="Registration form">
                <div class="form-group">
                    <label class="form-label" for="name">Full Name</label>
                    <input type="text" id="name" class="form-control" placeholder="Enter your full name" required minlength="2">
                </div>

                <div class="form-group">
                    <label class="form-label" for="email">Email Address</label>
                    <input type="email" id="email" class="form-control" placeholder="Enter your email" required aria-required="true" autocomplete="email">
                </div>

                <div class="form-group">
                    <label class="form-label" for="phone">Phone Number (10 digits)</label>
                    <input type="tel" id="phone" class="form-control" placeholder="10-digit phone number" required pattern="[0-9]{10}" aria-required="true" autocomplete="tel">
                </div>

                <div class="form-group">
                    <label class="form-label" for="password">Password (min 6 characters)</label>
                    <input type="password" id="password" class="form-control" placeholder="Create a password" required minlength="6" aria-required="true" autocomplete="new-password">
                </div>

                <div class="form-group">
                    <label class="form-label" for="role">I am a</label>
                    <select id="role" class="form-select" required aria-required="true">
                        <option value="">Select your role</option>
                        <option value="user">User (Donor + Receiver)</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>

                <!-- Optional donor profile fields (available for User accounts) -->
                <div id="donorFields" class="hidden">
                    <div class="card-header" style="margin-top: 1.5rem;">Donor Profile</div>
                    
                    <div class="form-group">
                        <label class="form-label">Blood Group</label>
                        <select id="bloodGroup" class="form-select">
                            <option value="">Select blood group</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Age Group</label>
                        <select id="ageGroup" class="form-select">
                            <option value="">Select age group</option>
                            <option value="18-25">18-25</option>
                            <option value="26-35">26-35</option>
                            <option value="36-45">36-45</option>
                            <option value="46-60">46-60</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <input type="text" id="address" class="form-control" placeholder="Enter your address">
                    </div>

                    <div class="form-group">
                        <label class="form-label">City</label>
                        <input type="text" id="city" class="form-control" placeholder="Enter your city">
                    </div>

                    <div class="form-group">
                        <label class="form-label">State</label>
                        <input type="text" id="state" class="form-control" placeholder="Enter your state">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Pincode (6 digits)</label>
                        <input type="text" id="pincode" class="form-control" placeholder="Enter 6-digit pincode" pattern="[0-9]{6}">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Location Coordinates</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <input type="number" id="latitude" class="form-control" placeholder="Latitude" step="any">
                            <input type="number" id="longitude" class="form-control" placeholder="Longitude" step="any">
                        </div>
                        <button type="button" id="getLocationBtn" class="btn btn-secondary" style="margin-top: 0.5rem;">
                            üìç Get My Location
                        </button>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary btn-block\" style=\"margin-top: 1.5rem;\">Register</button>
            </form>

            <div style="text-align: center; margin-top: 1.5rem;">
                <p>Already have an account? <a href="login.html">Login here</a></p>
                <p><a href="index.html">Back to Home</a></p>
            </div>
        </div>
    </main>

    <script src="js/common.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // Show/hide donor fields based on role selection
        document.getElementById('role').addEventListener('change', function() {
            const donorFields = document.getElementById('donorFields');
            if (this.value === 'user') {
                donorFields.classList.remove('hidden');
                // Donor fields are optional at registration (user can donate later)
                document.getElementById('bloodGroup').required = false;
                document.getElementById('ageGroup').required = false;
                document.getElementById('address').required = false;
                document.getElementById('city').required = false;
                document.getElementById('state').required = false;
                document.getElementById('pincode').required = false;
                document.getElementById('latitude').required = false;
                document.getElementById('longitude').required = false;
            } else {
                donorFields.classList.add('hidden');
                // Remove required from donor fields
                document.getElementById('bloodGroup').required = false;
                document.getElementById('ageGroup').required = false;
                document.getElementById('address').required = false;
                document.getElementById('city').required = false;
                document.getElementById('state').required = false;
                document.getElementById('pincode').required = false;
                document.getElementById('latitude').required = false;
                document.getElementById('longitude').required = false;
            }
        });

        // Get user location with better error handling
        document.getElementById('getLocationBtn').addEventListener('click', function() {
            // Check if running on HTTPS (required for geolocation)
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                showAlert('Geolocation requires HTTPS. Please enter location manually or use a secure connection.', 'warning');
                return;
            }
            
            if (navigator.geolocation) {
                this.textContent = 'üìç Getting location...';
                this.disabled = true;
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        document.getElementById('latitude').value = position.coords.latitude.toFixed(6);
                        document.getElementById('longitude').value = position.coords.longitude.toFixed(6);
                        this.textContent = '‚úì Location obtained';
                        showAlert('Location captured successfully!', 'success');
                        setTimeout(() => {
                            this.textContent = 'üìç Get My Location';
                            this.disabled = false;
                        }, 2000);
                    },
                    (error) => {
                        let errorMsg = 'Unable to get location. ';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMsg += 'Please allow location access in your browser settings.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMsg += 'Location information unavailable.';
                                break;
                            case error.TIMEOUT:
                                errorMsg += 'Location request timed out.';
                                break;
                            default:
                                errorMsg += 'Please enter manually.';
                        }
                        showAlert(errorMsg, 'danger');
                        this.textContent = 'üìç Get My Location';
                        this.disabled = false;
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 300000 }
                );
            } else {
                showAlert('Geolocation is not supported by your browser. Please enter coordinates manually.', 'danger');
            }
        });

        document.getElementById('registerForm').addEventListener('submit', handleRegister);
    </script>
</body>
</html>
