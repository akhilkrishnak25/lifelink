<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donor Dashboard - LifeLink v2.0</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#dc3545">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/dark-mode.css">
</head>
<body>
    <!-- Theme Toggle -->
    <button id="themeToggle" style="position: fixed; top: 5rem; right: 1rem; z-index: 1000; padding: 0.5rem 1rem; border-radius: 0.5rem; border: none; background: var(--bg-card, #fff); box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer;">
        üåô Dark
    </button>

    <!-- Notification Bell -->
    <div id="notificationBell" style="position: fixed; top: 1rem; right: 1rem; z-index: 1000; cursor: pointer;">
        <div style="position: relative;">
            <span style="font-size: 1.5rem;">üîî</span>
            <span id="notificationBadge" style="position: absolute; top: -5px; right: -5px; background: #dc3545; color: white; border-radius: 50%; padding: 0.2rem 0.4rem; font-size: 0.7rem; display: none;">0</span>
        </div>
    </div>

    <div class="navbar">
        <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
            <a href="donor-dashboard.html" class="navbar-brand">ü©∏ LifeLink v2.0</a>
            <button class="btn btn-secondary" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="container" style="margin-top: 2rem;">
        <div id="alertContainer"></div>

        <!-- Welcome Card -->
        <div class="card">
            <h2>Welcome, <span id="userName">Donor</span>! üëã</h2>
            <p>Blood Group: <span id="bloodGroup" class="blood-group">-</span></p>
        </div>

        <!-- Availability Toggle -->
        <div class="card">
            <div class="toggle-container">
                <span style="font-weight: 500;">Availability Status:</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="availabilityToggle">
                    <span class="slider"></span>
                </label>
                <span id="availabilityText">-</span>
            </div>
        </div>

        <!-- Statistics -->
        <div class="dashboard-grid">
            <div class="stat-card">
                <h3 id="totalDonations">0</h3>
                <p>Total Donations</p>
            </div>
            <div class="stat-card">
                <h3 id="daysSinceLast">-</h3>
                <p>Days Since Last Donation</p>
            </div>
            <div class="stat-card">
                <h3 id="canDonate">-</h3>
                <p>Can Donate</p>
            </div>
        </div>

        <!-- Gamification Card -->
        <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; text-align: center;">
                <div>
                    <h2 id="userPoints" style="color: white; margin: 0;">0</h2>
                    <p style="opacity: 0.9; margin: 0.5rem 0 0 0;">‚≠ê Points</p>
                </div>
                <div>
                    <h2 id="userLevel" style="color: white; margin: 0;">1</h2>
                    <p style="opacity: 0.9; margin: 0.5rem 0 0 0;">üèÜ Level</p>
                </div>
                <div>
                    <h2 id="userBadges" style="color: white; margin: 0;">0</h2>
                    <p style="opacity: 0.9; margin: 0.5rem 0 0 0;">üéñÔ∏è Badges</p>
                </div>
                <div>
                    <h2 id="userRank" style="color: white; margin: 0;">-</h2>
                    <p style="opacity: 0.9; margin: 0.5rem 0 0 0;">üìä Rank</p>
                </div>
            </div>
            <button class="btn" style="margin-top: 1rem; background: white; color: #667eea;" onclick="window.location.href='#leaderboard'">View Leaderboard</button>
        </div>

        <!-- Nearby Requests -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <div class="card-header" style="margin: 0;">Nearby Blood Requests</div>
                <button class="btn btn-primary" onclick="loadNearbyRequests()">üîÑ Refresh</button>
            </div>
            
            <div id="nearbyRequests">
                <div class="spinner"></div>
            </div>
        </div>

        <!-- Donation History -->
        <div class="card">
            <div class="card-header">Donation History</div>
            <div id="donationHistory">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/common.js"></script>
    <script src="js/theme.js"></script>
    <script src="js/pwa.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/gamification.js"></script>
    <script src="js/donor.js"></script>
    
    <script>
        // Initialize theme
        const themeManager = new ThemeManager();
        const themeToggle = document.getElementById('themeToggle');
        themeToggle.addEventListener('click', () => {
            themeManager.toggleTheme();
            themeToggle.textContent = themeManager.getTheme() === 'dark' ? '‚òÄÔ∏è Light' : 'üåô Dark';
        });
        themeToggle.textContent = themeManager.getTheme() === 'dark' ? '‚òÄÔ∏è Light' : 'üåô Dark';

        // Initialize PWA
        const pwaManager = new PWAManager();

        // Initialize notifications
        const notificationService = new NotificationService('http://localhost:5000');
        notificationService.connect();
        
        // Update notification badge
        notificationService.onNotificationReceived((notification) => {
            const badge = document.getElementById('notificationBadge');
            const count = parseInt(badge.textContent || '0') + 1;
            badge.textContent = count;
            badge.style.display = 'block';
        });

        // Initialize gamification
        const gamificationClient = new GamificationClient('http://localhost:5000');
        
        // Load gamification data
        async function loadGamificationData() {
            try {
                const profile = await gamificationClient.getProfile();
                if (profile) {
                    document.getElementById('userPoints').textContent = profile.points || 0;
                    document.getElementById('userLevel').textContent = profile.level || 1;
                    document.getElementById('userBadges').textContent = profile.badges?.length || 0;
                    
                    const leaderboard = await gamificationClient.getLeaderboard();
                    const userRank = leaderboard.findIndex(u => u.userId === profile.userId) + 1;
                    document.getElementById('userRank').textContent = userRank || '-';
                }
            } catch (error) {
                console.log('Gamification features loading...');
            }
        }
        
        loadGamificationData();
    </script>
</body>
</html>
